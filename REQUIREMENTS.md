# upmo-demo 要件定義書

## 1. プロジェクト概要

### 1.1 プロジェクト名
**upmo-demo** - 統合ビジネス管理プラットフォーム

### 1.2 目的
中小企業向けの統合ビジネス管理ツール。顧客管理、営業管理、在庫管理、財務管理、PDCA管理などの機能を一元化し、チーム全体で情報を共有・活用できるプラットフォームを提供する。

### 1.3 主要機能
- **顧客管理**: 顧客情報の一元管理、メモ、議事録の記録
- **営業管理**: 営業案件、見積、受注、進捗管理
- **在庫・発注管理**: 在庫管理、発注管理
- **財務管理**: 見積、受注、請求、経費管理
- **PDCA管理**: 計画、実行、評価、改善のサイクル管理
- **ドキュメント管理**: 契約書、マニュアル、社内規則の管理
- **タスク管理**: 個人・チームタスクの管理
- **議事録管理**: 会議議事録の記録と管理
- **カレンダー**: スケジュール管理
- **AIアシスタント**: 自然言語での情報検索・質問応答

### 1.4 技術スタック
- **フロントエンド**: Next.js 14 (App Router), React, TypeScript, Tailwind CSS
- **バックエンド**: Next.js API Routes
- **データベース**: Firebase Firestore
- **認証**: Firebase Authentication
- **ストレージ**: Firebase Storage
- **AI**: OpenAI API (推測)

---

## 2. ユーザー管理・認証

### 2.1 認証機能
- **ログイン**: メールアドレス・パスワード認証
- **認証状態管理**: Firebase Authenticationを使用
- **セッション管理**: ブラウザセッションで管理

### 2.2 ユーザーロール
- **admin**: 管理者権限
  - 利用者招待
  - ユーザー管理（作成・編集・削除）
  - パスワード変更
  - サイドバー設定
  - すべての機能にアクセス可能
- **manager**: マネージャー権限（将来実装予定）
- **user**: 一般ユーザー権限
  - 基本的な機能にアクセス可能
  - 利用者招待は不可

### 2.3 会社単位のデータ共有
- すべてのデータは`companyName`で会社単位に共有
- 同じ`companyName`のユーザー間でデータを共有
- サイドバー設定、契約書、AIチャット履歴なども会社単位で共有

### 2.4 利用者招待機能
- **場所**: `/admin/users`ページ
- **権限**: `admin`ロールのみ
- **機能**:
  - メールアドレス、パスワード、名前、部署、役職を入力してユーザーを作成
  - 同じ`companyName`のユーザーのみ招待可能
  - 作成されたユーザーは自動的に同じ`companyName`で登録される

---

## 3. メインメニュー（サイドバー）

### 3.1 メインメニュー構成
サイドバーには以下のメニューが表示されます：

#### 3.1.1 固定メニュー（常に表示）
1. **ダッシュボード** (`/`)
   - 概要表示
   - カレンダー表示
   - チームイベント表示
   - イベント追加・編集・削除

2. **AIアシスタント** (`/personal-chat`)
   - 自然言語での質問応答
   - アプリ内の情報を検索
   - チャット履歴の保存（会社単位で共有）
   - 個人チャット機能（将来実装予定）

3. **タスク管理** (`/todo`)
   - 個人タスクの作成・編集・削除
   - タスクの共有
   - 優先度設定（低・中・高）
   - ステータス管理（共有事項・ToDoリスト・進行中・完了）
   - 期限設定
   - 期間設定（開始日・終了日）
   - 完了時のメモ記録
   - AIによるタスク作成支援

4. **利用者管理** (`/admin/users`)
   - ユーザー一覧表示
   - ユーザー作成（利用者招待）
   - ユーザー編集
   - ユーザー削除
   - パスワード変更
   - ロール変更
   - **権限**: `admin`ロールのみ

#### 3.1.2 カスタマイズ可能メニュー
サイドバー設定（`/admin/sidebar-config`）で有効化・無効化が可能：

**顧客管理カテゴリ**
- **顧客管理** (`/customers`)
  - 顧客情報の一覧表示
  - 顧客の追加・編集・削除
  - 顧客詳細表示
  - メモの追加・編集・削除（複数メモ対応）
  - 議事録の追加・編集・削除
  - 検索機能
  - ステータス管理（アクティブ・非アクティブ・見込み客）
  - 優先度管理（低・中・高）
  - 契約日管理
  - ウェブサイトURL管理

- **リスト** (`/customers/list`)
  - 顧客一覧のテーブル表示
  - 検索機能
  - メモ数の表示

**在庫・発注管理カテゴリ**
- **在庫管理** (`/inventory`)
  - 在庫アイテムの管理
  - 在庫数の追跡
  - 在庫の追加・編集・削除

- **発注管理** (`/purchases`)
  - 発注情報の管理
  - 発注の追加・編集・削除

**財務管理カテゴリ**
- **見積管理** (`/sales/quotes`)
  - 見積書の作成・管理
  - 見積の追加・編集・削除

- **受注管理** (`/sales/orders`)
  - 受注情報の管理
  - 受注の追加・編集・削除

- **請求管理** (`/billing`)
  - 請求書の作成・管理
  - 請求の追加・編集・削除

- **経費管理** (`/expenses`)
  - 経費の記録・管理
  - 経費の追加・編集・削除

**PDCA管理カテゴリ**
- **計画管理** (`/pdca/plan`)
  - 営業計画・目標設定
  - 計画の作成・編集・削除

- **実行管理** (`/pdca/do`)
  - 活動記録・タスク管理
  - 実行記録の作成・編集・削除

- **評価管理** (`/pdca/check`)
  - 実績分析・KPI管理
  - 評価の作成・編集・削除

- **改善管理** (`/pdca/action`)
  - 改善アクション・次期計画
  - 改善アクションの作成・編集・削除

**その他カテゴリ**
- **議事録管理** (`/meeting-notes`)
  - 会議議事録の記録
  - 議事録の追加・編集・削除
  - AIによる議事録の要約
  - 議事録の分類
  - アクション項目の抽出

- **カレンダー** (`/calendar`)
  - スケジュール管理
  - イベントの追加・編集・削除
  - チームイベントの表示

- **レポート** (`/reports`)
  - 各種レポートの生成
  - レポートの表示

- **分析ダッシュボード** (`/analytics`)
  - データ分析と可視化
  - 分析結果の表示

**ドキュメント管理カテゴリ**
- **契約書管理** (`/admin/contracts`)
  - 契約書・マニュアル・社内規則の管理
  - 手動入力によるドキュメント作成
  - 項目ごとの入力（概要・機能・料金・手順・サポート・規則・条件・Q&A）
  - AIによるドキュメント解析
  - ドキュメントの追加・編集・削除
  - **権限**: 全ユーザー（会社単位で共有）

---

## 4. 各機能の詳細

### 4.1 ダッシュボード (`/`)

#### 機能
- **概要表示**: アプリのメインページ
- **カレンダー表示**: シンプルなカレンダービュー
- **チームイベント表示**: 同じ会社のユーザーのイベントを表示
- **イベント管理**:
  - イベントの追加
  - イベントの編集
  - イベントの削除
  - イベント詳細の表示
  - 参加者の設定

#### データ共有
- イベントは会社単位で共有（`companyName`でフィルタリング）

---

### 4.2 AIアシスタント (`/personal-chat`)

#### 機能
- **自然言語での質問応答**: ユーザーが自然な日本語で質問すると、アプリ内の情報を検索して回答
- **情報検索**: 以下の情報を検索可能
  - 顧客情報
  - 営業案件
  - 進捗メモ
  - 議事録
  - タスク
  - イベント
  - 社内ドキュメント（契約書・マニュアル）
  - PDCA管理データ

#### 検索機能
- **意図解析**: 質問内容から検索対象を自動判定
- **項目ごとの検索**: ドキュメントの特定項目（料金・機能・手順など）を指定して検索可能
  - 例: 「Signal.の料金について教えて」→ 料金セクションのみを返す
  - 例: 「Signal.について教えて」→ 概要セクションを返す

#### チャット履歴
- **会社単位で共有**: 同じ会社のユーザーが同じAIアシスタントチャット履歴を共有
- **個人チャット**: 個人チャット機能（将来実装予定）

#### 技術仕様
- **API**: `/api/ai-chat`
- **検索ロジック**: 意図解析 → データ検索 → 結果フォーマット → AI応答生成

---

### 4.3 タスク管理 (`/todo`)

#### 機能
- **タスクの作成**: 
  - タイトル
  - 説明
  - 優先度（低・中・高）
  - ステータス（共有事項・ToDoリスト・進行中・完了）
  - 期限
  - 期間（開始日・終了日）
  - 担当者
  - タグ

- **タスクの編集・削除**
- **タスクの共有**: 他のユーザーとタスクを共有
- **完了時のメモ**: タスク完了時にメモを記録
- **AI支援**: AIによるタスク作成支援

#### データ共有
- 自分のタスクと共有されたタスクを表示
- 同じ会社のユーザー間で共有可能

---

### 4.4 顧客管理 (`/customers`)

#### 機能
- **顧客一覧表示**: 顧客情報の一覧を表示
- **顧客の追加・編集・削除**:
  - 名前
  - メールアドレス
  - 会社名
  - 電話番号
  - ウェブサイトURL
  - 契約日
  - ステータス（アクティブ・非アクティブ・見込み客）
  - 優先度（低・中・高）

- **顧客詳細表示**: モーダルで顧客詳細を表示
- **メモ管理**: 
  - 複数のメモを追加可能
  - メモの編集・削除
  - メモには作成者と作成日時が記録される

- **議事録管理**:
  - 議事録の追加・編集・削除
  - 議題、日時、場所、参加者、アクション項目を記録

- **検索機能**: 顧客名・会社名・メールアドレスで検索

#### データ共有
- 同じ会社のユーザー間で顧客情報を共有

---

### 4.5 営業案件管理 (`/sales/cases`)

#### 機能
- **案件一覧表示**: 営業案件の一覧を表示
- **案件の追加・編集・削除**:
  - 案件名
  - 顧客名
  - 顧客会社名
  - ステータス（見込み客・見極め中・提案中・交渉中・成約・失注）
  - ステージ
  - 予定クロージング日
  - 見積金額
  - 成約確率
  - 説明
  - タグ
  - 担当者

- **フィルタリング**: ステータスでフィルタリング可能

#### データ共有
- 同じ会社のユーザー間で案件情報を共有（将来実装予定）

---

### 4.6 契約書管理 (`/admin/contracts`)

#### 機能
- **ドキュメント一覧表示**: 契約書・マニュアル・社内規則の一覧を表示
- **ドキュメントの追加・編集・削除**:
  - タイトル
  - 説明
  - タイプ（会議・ポリシー・契約・マニュアル・その他）
  - 項目ごとの入力:
    - **概要** (`overview`): 文字列
    - **機能** (`features`): 配列（文字列またはオブジェクト）
    - **料金** (`pricing`): 配列（文字列またはオブジェクト）
    - **手順** (`procedures`): 配列（文字列またはオブジェクト）
    - **サポート** (`support`): 配列（オプション）
    - **規則** (`rules`): 配列（オプション）
    - **条件** (`terms`): 配列（オプション）
    - **Q&A** (`qa`): 質問と回答の配列（オプション）
  - タグ
  - 優先度（低・中・高）

- **AI解析**: テキストを入力すると、AIが自動的に項目ごとに分類
- **検索機能**: タイトル・内容で検索

#### データ共有
- 同じ会社のユーザー間でドキュメントを共有
- AIチャットから項目ごとに検索可能

#### データ構造
- Firestoreの`manualDocuments`コレクションに保存
- `companyName`で会社単位に共有
- `sections`オブジェクトに項目ごとのデータを保存

---

### 4.7 議事録管理 (`/meeting-notes`)

#### 機能
- **議事録一覧表示**: 議事録の一覧を表示
- **議事録の追加・編集・削除**:
  - タイトル
  - 日付
  - 時間
  - 場所
  - 担当者
  - 備考
  - アクション項目（項目、担当者、期限）

- **AI機能**:
  - **要約**: 議事録をAIで要約
  - **分類**: 議事録を自動分類
  - **アクション項目抽出**: 議事録からアクション項目を自動抽出

#### データ共有
- 同じ会社のユーザー間で議事録を共有

---

### 4.8 PDCA管理

#### 4.8.1 計画管理 (`/pdca/plan`)
- 営業計画・目標設定
- 計画の作成・編集・削除

#### 4.8.2 実行管理 (`/pdca/do`)
- 活動記録・タスク管理
- 実行記録の作成・編集・削除

#### 4.8.3 評価管理 (`/pdca/check`)
- 実績分析・KPI管理
- 評価の作成・編集・削除

#### 4.8.4 改善管理 (`/pdca/action`)
- 改善アクション・次期計画
- 改善アクションの作成・編集・削除

---

### 4.9 在庫管理 (`/inventory`)

#### 機能
- **在庫一覧表示**: 在庫アイテムの一覧を表示
- **在庫の追加・編集・削除**:
  - アイテム名
  - 数量
  - その他の情報

---

### 4.10 発注管理 (`/purchases`)

#### 機能
- **発注一覧表示**: 発注情報の一覧を表示
- **発注の追加・編集・削除**:
  - 発注情報の管理

---

### 4.11 財務管理

#### 4.11.1 見積管理 (`/sales/quotes`)
- 見積書の作成・管理
- 見積の追加・編集・削除

#### 4.11.2 受注管理 (`/sales/orders`)
- 受注情報の管理
- 受注の追加・編集・削除

#### 4.11.3 請求管理 (`/billing`)
- 請求書の作成・管理
- 請求の追加・編集・削除

#### 4.11.4 経費管理 (`/expenses`)
- 経費の記録・管理
- 経費の追加・編集・削除

---

### 4.12 カレンダー (`/calendar`)

#### 機能
- **スケジュール表示**: カレンダービューでスケジュールを表示
- **イベント管理**:
  - イベントの追加
  - イベントの編集
  - イベントの削除
  - イベント詳細の表示

#### データ共有
- 同じ会社のユーザー間でイベントを共有

---

### 4.13 カスタムタブ (`/custom/[slug]`)

#### 機能
- **カスタムページの作成**: ユーザーが独自のページを作成可能
- **コンポーネント追加**: 以下のコンポーネントを追加可能
  - テキストコンポーネント
  - データテーブルコンポーネント
  - フォームコンポーネント
  - カレンダーコンポーネント

---

## 5. サイドバー設定

### 5.1 設定機能
- **場所**: `/admin/sidebar-config`（将来実装予定）
- **権限**: `admin`ロールのみ
- **機能**:
  - メインメニューの表示・非表示を設定
  - カスタマイズ可能メニューの有効化・無効化
  - メニューの表示順序を設定

### 5.2 データ共有
- サイドバー設定は会社単位で共有
- 同じ会社のユーザーが同じサイドバー設定を共有

---

## 6. データ構造

### 6.1 ユーザーデータ
```typescript
{
  id: string,                    // Firebase Auth UID
  email: string,                  // メールアドレス
  displayName: string,            // 表示名
  companyName: string,           // 会社名（必須）
  role: 'admin' | 'manager' | 'user',
  status: 'active' | 'inactive' | 'suspended',
  department?: string,           // 部署
  position?: string,             // 役職
  createdAt: Timestamp,
  createdBy?: string | null,     // 作成者のUID
  updatedAt?: Timestamp,
  subscriptionType?: string,     // サブスクリプションタイプ
  lastLoginAt?: Timestamp
}
```

### 6.2 顧客データ
```typescript
{
  id: string,
  name: string,
  email: string,
  company: string,
  phone: string,
  website?: string,
  status: 'active' | 'inactive' | 'prospect',
  priority: 'low' | 'medium' | 'high',
  contractDate?: Date,
  notes: Note[],                 // 複数のメモ
  createdAt: Date,
  companyName: string           // 会社名（共有用）
}
```

### 6.3 契約書データ
```typescript
{
  id: string,
  title: string,
  description: string,
  type: 'meeting' | 'policy' | 'contract' | 'manual' | 'other',
  sections: {
    overview: string,
    features: (string | SectionItem)[],
    pricing: (string | SectionItem)[],
    procedures: (string | SectionItem)[],
    support?: (string | SectionItem)[],
    rules?: (string | SectionItem)[],
    terms?: (string | SectionItem)[],
    qa?: { question: string; answer: string }[]
  },
  tags: string[],
  priority: 'low' | 'medium' | 'high',
  companyName: string,          // 会社名（共有用）
  userId: string,
  createdAt: Timestamp,
  lastUpdated: Timestamp
}
```

---

## 7. セキュリティ・権限管理

### 7.1 認証
- Firebase Authenticationを使用
- メールアドレス・パスワード認証
- 認証トークンによるAPI認証

### 7.2 データアクセス制御
- **会社単位のデータ分離**: すべてのデータは`companyName`で分離
- **ロールベースアクセス制御**: 
  - `admin`: すべての機能にアクセス可能
  - `user`: 基本的な機能にアクセス可能

### 7.3 API認証
- すべてのAPIエンドポイントで認証トークンを検証
- 認証トークンから`userId`と`companyName`を取得
- `companyName`でデータをフィルタリング

---

## 8. 今後の改善予定

### 8.1 設計見直し
- **セルフサービス型の初回登録**: 最初のユーザーが自分で会社を登録
- **データ整合性の確保**: `companyName`が空のユーザーを修正
- **属人化の防止**: 利用者招待の権限を明確化

### 8.2 機能追加
- **個人チャット機能**: ユーザー間の直接チャット
- **通知機能**: イベント・タスクの通知
- **レポート機能**: 詳細なレポート生成
- **分析機能**: より詳細なデータ分析

### 8.3 パフォーマンス改善
- **データ取得の最適化**: 不要なデータ取得を削減
- **キャッシュ機能**: 頻繁にアクセスするデータをキャッシュ

---

## 9. 技術的な制約・注意事項

### 9.1 Firestoreの制約
- `undefined`は保存できない（`null`または空文字列を使用）
- バッチ操作は500件まで
- クエリの複雑さに制限あり

### 9.2 データ整合性
- `companyName`が空のユーザーが存在する可能性がある
- マイグレーションスクリプトで修正が必要

### 9.3 検索機能
- AIチャットの検索は`companyName`に依存
- `companyName`が空の場合は`userId`でフォールバック

---

## 10. まとめ

upmo-demoは、中小企業向けの統合ビジネス管理プラットフォームです。顧客管理、営業管理、在庫管理、財務管理、PDCA管理などの機能を一元化し、チーム全体で情報を共有・活用できるよう設計されています。

**主要な特徴**:
- 会社単位のデータ共有
- AIアシスタントによる自然言語検索
- 柔軟なサイドバー設定
- 包括的なビジネス管理機能

**今後の課題**:
- データ整合性の確保
- セルフサービス型の初回登録
- 属人化の防止
