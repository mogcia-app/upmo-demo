# 設計見直し提案

## 現状の問題点

### 1. データ不整合の問題

**問題:**
- ユーザーの`companyName`が空の場合がある
- ドキュメントは`companyName`で保存されているが、ユーザーの`companyName`が空だと検索できない
- `userId`で検索しても見つからない（ドキュメントが`companyName`で保存されているため）

**原因:**
- admin側でユーザーを作成する際に`companyName`が設定されていない可能性
- 既存ユーザーの`companyName`が設定されていない

### 2. 設計上の問題

**現状のフロー:**
1. adminで1人だけ登録（会社名・名前・メアド・仮パスワード）
2. upmo-demoに入ってもらう
3. 利用者招待で招待する

**問題点:**
- 最初の1人が誰かが不明確（属人化）
- 利用者招待の権限が不明確
- 誰が設定を管理するかが不明確

## 設計見直し案

### 案1: セルフサービス型（推奨）

**コンセプト:**
- 最初のユーザーが自分で会社を登録し、自分で利用者を招待できる

**フロー:**
1. **初回登録**:
   - 新規ユーザーがupmo-demoにアクセス
   - 会社名を入力して登録（会社の初期設定）
   - 自動的に`admin`ロールが付与される

2. **利用者招待**:
   - 最初のユーザー（admin）が利用者を招待
   - 招待されたユーザーは同じ`companyName`で自動登録

3. **権限管理**:
   - `admin`ロール: 利用者招待、設定変更が可能
   - `manager`ロール: 一部の設定変更が可能
   - `user`ロール: 通常の利用のみ

**メリット:**
- ✅ 属人化を防げる（誰でも最初のユーザーになれる）
- ✅ セルフサービスで運用できる
- ✅ 明確な権限管理

**デメリット:**
- ⚠️ 会社名の重複チェックが必要
- ⚠️ 初回登録時のUI/UX設計が必要

### 案2: ハイブリッド型

**コンセプト:**
- admin側で会社を登録し、最初のユーザーを招待
- その後は、upmo-demo内で利用者を招待できる

**フロー:**
1. **会社登録（admin側）**:
   - admin側で会社を登録（会社名、初期ユーザー情報）
   - 初期ユーザーに招待メールを送信

2. **初回ログイン**:
   - 初期ユーザーがupmo-demoにログイン
   - 自動的に`admin`ロールが付与される

3. **利用者招待**:
   - adminロールのユーザーが利用者を招待
   - 招待されたユーザーは同じ`companyName`で自動登録

**メリット:**
- ✅ admin側で会社を一元管理できる
- ✅ 初回設定が明確
- ✅ 既存のフローと近い

**デメリット:**
- ⚠️ admin側の管理が必要
- ⚠️ 属人化のリスクが残る

### 案3: 完全セルフサービス型

**コンセプト:**
- すべてupmo-demo内で完結
- admin側は不要

**フロー:**
1. **初回登録**:
   - 新規ユーザーがupmo-demoにアクセス
   - 会社名を入力して登録
   - 自動的に`admin`ロールが付与される

2. **利用者招待**:
   - adminロールのユーザーが利用者を招待
   - 招待されたユーザーは同じ`companyName`で自動登録

3. **会社設定**:
   - adminロールのユーザーが会社設定を管理
   - サイドバー設定、契約書管理など

**メリット:**
- ✅ 完全にセルフサービス
- ✅ admin側の管理が不要
- ✅ 属人化を完全に防げる

**デメリット:**
- ⚠️ 既存のadmin側の機能を移行する必要がある
- ⚠️ 大規模な変更が必要

## 推奨案: 案1（セルフサービス型）

### 実装内容

#### 1. 初回登録フロー

**新規ファイル:** `src/app/register/page.tsx`

```typescript
// 初回登録画面
- 会社名入力（必須）
- 名前入力（必須）
- メールアドレス入力（必須）
- パスワード入力（必須）
- 登録ボタン

// 登録処理
1. Firebase Authでユーザーを作成
2. Firestoreにユーザー情報を保存
   - companyName: 入力された会社名
   - role: 'admin'（最初のユーザーは自動的にadmin）
   - status: 'active'
3. ログイン状態にして、ダッシュボードにリダイレクト
```

#### 2. 利用者招待の改善

**既存ファイル:** `src/app/api/admin/users/route.ts`

```typescript
// 改善点
1. companyNameが空の場合は、招待者のcompanyNameを使用
2. 招待者のcompanyNameが空の場合はエラー
3. 招待されたユーザーは自動的に同じcompanyNameで登録
```

#### 3. 会社設定ページの追加

**新規ファイル:** `src/app/settings/company/page.tsx`

```typescript
// 会社設定画面（adminロールのみアクセス可能）
- 会社名の表示・変更
- 利用者一覧
- 利用者招待
- サイドバー設定
- 契約書管理
```

#### 4. データ整合性の確保

**マイグレーションスクリプト:** `scripts/fix-company-name.ts`

```typescript
// 既存ユーザーのcompanyNameを修正
1. companyNameが空のユーザーを検索
2. 同じ会社の他のユーザーのcompanyNameを取得
3. もし見つからなければ、デフォルト値を設定
4. ユーザーに通知して、設定画面で変更してもらう
```

### 実装ステップ

#### フェーズ1: データ整合性の確保（最優先）

1. **マイグレーションスクリプトの作成**
   - `companyName`が空のユーザーを修正
   - 既存のドキュメントの`companyName`を確認

2. **バリデーションの追加**
   - ユーザー作成時に`companyName`が必須であることを確認
   - ドキュメント作成時に`companyName`が必須であることを確認

#### フェーズ2: 初回登録フローの実装

1. **登録画面の作成**
   - 会社名入力フォーム
   - バリデーション

2. **登録APIの実装**
   - 会社名を含むユーザー登録
   - 自動的に`admin`ロールを付与

#### フェーズ3: 利用者招待の改善

1. **招待フローの改善**
   - `companyName`の自動設定
   - エラーハンドリングの改善

2. **権限チェックの追加**
   - `admin`ロールのみが利用者を招待できる

#### フェーズ4: 会社設定ページの追加

1. **設定画面の作成**
   - 会社名の表示・変更
   - 利用者一覧
   - 利用者招待

2. **権限管理**
   - `admin`ロールのみが設定を変更できる

## 即座に対応すべき問題

### 1. データ整合性の確保

**問題:** `companyName`が空のユーザーが存在する

**対応:**
1. マイグレーションスクリプトで既存ユーザーの`companyName`を修正
2. ユーザー作成時に`companyName`が必須であることを確認
3. ログイン時に`companyName`が空の場合は、設定画面にリダイレクト

### 2. 検索機能の改善

**問題:** `companyName`が空の場合、ドキュメントが見つからない

**対応:**
1. `companyName`が空の場合は、`userId`で検索（既に実装済み）
2. ただし、これは一時的な対応
3. 根本的には、すべてのユーザーに`companyName`を設定する必要がある

## まとめ

### 推奨する設計

**案1（セルフサービス型）を推奨**

**理由:**
- 属人化を防げる
- セルフサービスで運用できる
- 明確な権限管理
- 既存のフローと比較的変更が少ない

### 実装優先順位

1. **最優先**: データ整合性の確保（マイグレーションスクリプト）
2. **高**: 初回登録フローの実装
3. **中**: 利用者招待の改善
4. **低**: 会社設定ページの追加

### 次のステップ

1. マイグレーションスクリプトを作成して、既存ユーザーの`companyName`を修正
2. 初回登録フローの実装を開始
3. 利用者招待の改善を実施

## 質問・確認事項

1. **admin側の役割**: admin側は今後も使用する予定ですか？
2. **会社名の重複**: 同じ会社名で複数の会社が登録されても良いですか？
3. **権限管理**: `admin`ロールは複数人いても良いですか？
4. **移行期間**: 既存ユーザーへの影響を最小限にする移行期間は必要ですか？

